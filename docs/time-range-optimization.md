# 時間範囲指定による最適化

## 🎯 概要

字幕解析モードに開始・終了時間を指定できる機能を追加しました。これにより、必要な部分のみを処理することで大幅なリソース削減が可能になります。

## 📊 効率化の効果

### 1. ダウンロード最適化
- **ytdl-core `begin`オプション**: 開始時間からのダウンロードが可能
- **制限**: 終了時間の指定は不可（ytdl-coreの仕様）
- **効果**: 長い動画の後半部分のみが必要な場合に有効

### 2. 音声抽出最適化
- **FFmpeg時間範囲指定**: `-ss`（開始）と`-t`（期間）オプション使用
- **効果**: 指定範囲のみを音声変換するため処理時間短縮

### 3. APIコスト最適化
- **Whisper API料金**: 音声の長さに基づく（$0.006/分）
- **効果**: 必要な部分のみ処理することでAPIコストを削減

## 💡 使用例

### 30分動画の5-10分部分のみ解析する場合

#### 従来の方法
1. 30分の動画全体をダウンロード（例: 300MB）
2. 30分の音声全体を抽出（例: 30MB）
3. 30分分のAPI料金（$0.18）

#### 最適化後
1. 5分以降をダウンロード（例: 250MB、17%削減）
2. 5-10分の音声のみ抽出（例: 5MB、83%削減）
3. 5分分のAPI料金（$0.03、83%削減）

## 🚀 実装内容

### UI改善
```html
<div class="time-range">
    <input type="text" id="start-time" placeholder="0:00">
    <span>〜</span>
    <input type="text" id="end-time" placeholder="5:00">
    <small>例: 1:30 (1分30秒) または 90 (90秒)</small>
</div>
```

### バックエンド処理
1. **ダウンロード時**: `begin`オプションで開始時間を指定
2. **音声抽出時**: FFmpegで時間範囲を指定して抽出
3. **音声認識時**: 抽出された範囲のみをWhisper APIに送信

## 📈 期待される効果

### リソース削減
| 項目 | 削減率 | 説明 |
|------|--------|------|
| 帯域使用量 | 0-50% | 開始時間指定時のみ |
| ストレージ | 20-90% | 範囲に応じて |
| 処理時間 | 20-90% | 範囲に応じて |
| APIコスト | 範囲に比例 | 正確に削減 |

### 具体例（1時間動画の10分間のみ）
- **音声ファイルサイズ**: 60MB → 10MB（83%削減）
- **処理時間**: 3分 → 30秒（83%削減）
- **APIコスト**: $0.36 → $0.06（83%削減）

## ⚠️ 制限事項

### ytdl-coreの制限
- 終了時間の直接指定は不可
- `begin`オプションは開始点のみ
- セグメント形式の動画では`range`オプション無効

### 現在の回避策
- フル動画をダウンロード後、FFmpegで範囲抽出
- 将来的にはストリーミング処理で改善可能

## 🔮 今後の改善案

### 1. ストリーミング処理
```javascript
// ダウンロードしながらFFmpegで処理
const stream = ytdl(url, options);
const ffmpeg = spawn('ffmpeg', ['-i', 'pipe:0', ...]);
stream.pipe(ffmpeg.stdin);
```

### 2. キャッシュ機能
- 同じ動画の異なる範囲を処理する場合
- ダウンロード済み動画を再利用

### 3. プレビュー機能
- 時間範囲を視覚的に選択
- 動画のサムネイルで確認

## 📚 使い方

1. YouTube URLを入力
2. 解析したい範囲を指定（任意）
   - 開始時間: `1:30` または `90`（秒）
   - 終了時間: `5:00` または `300`（秒）
3. 「動画を解析」ボタンをクリック

指定された範囲のみが処理され、効率的に字幕CSVが生成されます。