# 音声最適化ガイド

## 🎯 概要

字幕解析モードでは、フル品質の動画をOpenAI Whisper APIにアップロードするのは非効率です。音声認識用に最適化することで、以下の効果が期待できます：

- **ファイルサイズ**: 約50%削減
- **アップロード時間**: 大幅短縮
- **APIコスト**: 同等（料金は音声の長さベース）
- **認識精度**: 高品質を維持

## 🔧 最適化設定

### 現在の設定
```bash
ffmpeg -i "video.mp4" -vn -ac 1 -ar 22050 -ab 96k -acodec mp3 -y "audio_optimized.mp3"
```

### パラメータ解説
| パラメータ | 値 | 理由 |
|-----------|-----|------|
| `-vn` | - | 動画トラック除去（音声のみ） |
| `-ac 1` | モノラル | ステレオは音声認識に不要 |
| `-ar 22050` | 22.05kHz | 音質と効率のバランス |
| `-ab 96k` | 96kbps | 認識精度を保持する最低限 |
| `-acodec mp3` | MP3 | 汎用性とサイズのバランス |

## 📊 最適化効果

### テスト結果例
```
元動画:     0.92 MB (100%)
従来音声:   0.23 MB (25.1%)
最適化音声: 0.15 MB (16.3%) ← 約35%追加削減
```

### 認識精度比較
- **高品質**: "3年P組 ドラマの先生 はい、テスト開始しまーす"
- **最適化**: "3年P組 ドラマの先生 はい、テスト開始しまーす"
- **結論**: 実用的な精度を維持

## ⚖️ 設定比較

### 超高効率設定（非推奨）
```bash
# ファイルサイズ最小だが精度低下
-ar 16000 -ab 64k
```

### バランス設定（推奨）
```bash
# 現在の設定：精度と効率のバランス
-ar 22050 -ab 96k
```

### 高品質設定
```bash
# 従来設定：ファイルサイズ大
-ar 44100 -ab 128k
```

## 💡 用途別推奨設定

### 字幕解析（一般）
```bash
-vn -ac 1 -ar 22050 -ab 96k -acodec mp3
```
- ✅ 効率性重視
- ✅ 十分な認識精度
- ✅ 高速アップロード

### 高精度が必要な場合
```bash
-vn -ac 1 -ar 32000 -ab 128k -acodec mp3
```
- ✅ 高い認識精度
- ⚠️ ファイルサイズ増加

### 大容量動画（1時間以上）
```bash
-vn -ac 1 -ar 16000 -ab 80k -acodec mp3
```
- ✅ 25MB制限に収まりやすい
- ⚠️ 若干の精度低下

## 🚀 実装済み機能

### 自動最適化
- ✅ 字幕解析モードで自動適用
- ✅ ファイルサイズ比較ログ
- ✅ 圧縮率表示

### ログ出力例
```
📊 ファイルサイズ最適化結果:
   元動画: 0.92 MB
   最適化音声: 0.15 MB
   圧縮率: 84.2% 削減
```

## 🔮 今後の改善案

### 動的設定
```javascript
// 動画の長さに応じて設定を自動調整
if (videoDurationMinutes > 60) {
  // 長時間動画: より高圧縮
  return '-ar 16000 -ab 80k';
} else if (videoDurationMinutes < 5) {
  // 短時間動画: 高品質
  return '-ar 32000 -ab 128k';
} else {
  // 標準: バランス設定
  return '-ar 22050 -ab 96k';
}
```

### ユーザー設定
```javascript
// 設定ファイルでカスタマイズ可能
const audioSettings = {
  quality: 'balanced', // 'high' | 'balanced' | 'efficient'
  priority: 'speed'    // 'speed' | 'accuracy' | 'size'
};
```

## 📈 性能メトリクス

### 測定項目
- **ファイルサイズ削減率**
- **アップロード時間短縮**
- **認識精度維持率**
- **処理速度**

### 目標値
- ✅ サイズ削減: 30-50%
- ✅ 精度維持: 95%以上
- ✅ 速度向上: 20%以上

## ⚠️ 注意事項

### 制限事項
- **25MB制限**: Whisper APIの制限
- **音質劣化**: 極端な圧縮は避ける
- **言語依存**: 日本語以外では調整が必要な場合

### 推奨しない設定
```bash
# 極端に低い設定（精度大幅低下）
-ar 8000 -ab 32k   # ❌ 推奨しない

# ステレオ維持（不要な容量増加）
-ac 2              # ❌ 推奨しない
```

## 🔍 トラブルシューティング

### 認識精度が低い場合
1. ビットレートを上げる: `96k` → `128k`
2. サンプリングレートを上げる: `22050` → `32000`
3. 元動画の音質を確認

### ファイルサイズが大きすぎる場合
1. ビットレートを下げる: `96k` → `80k`
2. サンプリングレートを下げる: `22050` → `16000`
3. 動画分割を検討

### アップロード失敗の場合
1. ファイルサイズを確認（25MB未満）
2. 音声ファイルの整合性を確認
3. 一時的にビットレートを下げる