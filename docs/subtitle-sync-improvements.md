# 字幕同期の改善

## 🎯 問題と解決策

### 問題の原因
1. **タイムベースの不整合**: 各セグメントを切り出す際、字幕の時間が元動画の絶対時間のままだった
2. **FFmpegのシーク位置**: `-ss`オプションの位置により精度が変わる
3. **タイムスタンプの処理**: 負のタイムスタンプや不正確なPTSによるズレ

### 実装した解決策

#### 1. セグメントごとの個別SRT生成
```javascript
// 各セグメントは0秒から始まるように調整
const adjustedSegment = {
  start: 0,
  end: duration,
  text: segment.text
};
```

#### 2. FFmpegコマンドの最適化
```bash
# 改善前: -i の後に -ss （出力シーク）
ffmpeg -i video.mp4 -ss 10 -t 5 ...

# 改善後: -i の前に -ss （入力シーク）
ffmpeg -ss 10 -i video.mp4 -t 5 ...
```

#### 3. タイムスタンプ処理の改善
- `-avoid_negative_ts make_zero`: 負のタイムスタンプを防ぐ
- `-fflags +genpts`: PTSを再生成して同期を保つ

## 📊 効果

### Before
- 字幕が映像より早く/遅く表示される
- セグメント結合時に同期がずれる
- フレームレートによって誤差が蓄積

### After
- 各セグメントで正確な同期
- 結合後も同期を維持
- ミリ秒単位の精度

## 🔧 さらなる改善案

### 1. フレームレート対応
```javascript
// 動画のフレームレートを取得
const fps = await getVideoFPS(videoPath);
// フレーム単位での調整
const frameTime = 1 / fps;
```

### 2. 音声波形による微調整
- 音声の開始点を検出
- 字幕タイミングの自動調整

### 3. プレビュー機能
- リアルタイムで同期確認
- 手動での微調整機能

## ⚠️ 注意事項

### 可変フレームレート（VFR）動画
- YouTubeの一部動画はVFRを使用
- 固定フレームレート（CFR）への変換が必要な場合あり

### コーデックの互換性
- 一部のコーデックで同期問題が発生する可能性
- H.264での再エンコードにより解決

## 🎬 テスト方法

1. 短い動画（10秒程度）で字幕同期を確認
2. 話し始めと字幕表示のタイミングを視覚的に確認
3. 複数セグメントの結合後も同期が保たれることを確認