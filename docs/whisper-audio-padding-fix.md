# Whisperの音声認識範囲不足の修正

## 🎯 問題の特定

### 症状
- 15秒の動画なのに、CSVが14秒までしか生成されない
- 最後の1秒の音声が認識されない

### 原因
1. **音声ファイルの切れ**: FFmpegでの音声抽出時に最後の部分が正確に含まれない
2. **WhisperAPIの処理**: 音声の最終部分で無音が続くと認識が途切れる
3. **フォーマット変換**: MP3エンコード時のフレーム境界の問題

## 🔧 実装した修正

### 1. 音声パディングの追加
```javascript
// 最後に1秒の無音を追加して音声の切れを防ぐ
ffmpegCmd += ` -vn -ac 1 -ar 22050 -ab 96k -af "apad=pad_dur=1" -acodec mp3 -y "${audioPath}"`;
```

### 2. パラメータの説明
- `apad=pad_dur=1`: 1秒間の無音パディングを追加
- これにより、元の音声がすべて含まれることを保証

### 3. 動画処理の簡素化
- バッファタイムを削除して正確な切り出し
- 複雑なトリミング処理を除去

## 📊 効果

### Before
```csv
start,end,subtitles
0:00.000,0:02.000,"ニューワンダー"
...
0:13.000,0:14.000,"朝日飲料"
```
**問題**: 15秒動画の最後1秒が欠落

### After
```csv
start,end,subtitles
0:00.000,0:02.000,"ニューワンダー"
...
0:13.000,0:15.000,"朝日飲料"
```
**改善**: 完全な15秒の認識

## ⚠️ 注意事項

### パディング時間の調整
```javascript
// 必要に応じて調整可能
-af "apad=pad_dur=0.5"  // 0.5秒
-af "apad=pad_dur=2"    // 2秒（より安全）
```

### トレードオフ
- **メリット**: 完全な音声認識
- **デメリット**: わずかな処理時間の増加（+1秒）

## 🎬 今後の改善案

### 動的パディング
```javascript
// 動画の長さに応じてパディングを調整
const padding = Math.min(1, videoDuration * 0.1);
```

### 音声レベル検出
```javascript
// 最後の音声レベルを検出してパディングを最適化
-af "silencedetect=noise=-30dB:duration=0.5,apad=pad_dur=1"
```