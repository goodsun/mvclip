import ytdl from '@distube/ytdl-core';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export async function downloadVideo(url, options = {}) {
  try {
    // URLã®æ¤œè¨¼
    if (!ytdl.validateURL(url)) {
      throw new Error('ç„¡åŠ¹ãªYouTube URLã§ã™');
    }
    
    console.log('å‹•ç”»æƒ…å ±ã‚’å–å¾—ä¸­...');
    // å‹•ç”»æƒ…å ±ã‚’å–å¾—ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    const info = await ytdl.getInfo(url, {
      requestOptions: {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language': 'en-US,en;q=0.5',
          'Accept-Encoding': 'gzip, deflate',
          'DNT': '1',
          'Connection': 'keep-alive',
          'Upgrade-Insecure-Requests': '1'
        }
      }
    });
    
    const videoTitle = info.videoDetails.title.replace(/[^a-zA-Z0-9ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¥]/g, '_');
    const videoId = info.videoDetails.videoId;
    
    // ä¿å­˜ãƒ‘ã‚¹
    const timestamp = Date.now();
    const filename = `${videoId}_${timestamp}.mp4`;
    const outputPath = path.join(__dirname, '../../temp', filename);
    
    // tempãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    const tempDir = path.join(__dirname, '../../temp');
    if (!fs.existsSync(tempDir)) {
      fs.mkdirSync(tempDir, { recursive: true });
    }
    
    // åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèª
    const formats = ytdl.filterFormats(info.formats, 'audioandvideo');
    if (formats.length === 0) {
      throw new Error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
    console.log(`ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ•°: ${formats.length}`);
    const topFormats = formats
      .sort((a, b) => (parseInt(b.height) || 0) - (parseInt(a.height) || 0))
      .slice(0, 5);
    
    console.log('ğŸ¥ ä¸Šä½ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:');
    topFormats.forEach((format, i) => {
      console.log(`  ${i + 1}. ${format.height || 'N/A'}p, ${format.container || format.ext}, ${(parseInt(format.contentLength) / 1024 / 1024).toFixed(1)}MB`);
    });
    
    console.log('å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...');
    
    // ytdlã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆç”¨é€”åˆ¥æœ€é©åŒ–ï¼‰
    let ytdlOptions = {
      filter: 'audioandvideo',
      requestOptions: {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language': 'en-US,en;q=0.5',
          'Accept-Encoding': 'gzip, deflate',
          'DNT': '1',
          'Connection': 'keep-alive',
          'Upgrade-Insecure-Requests': '1'
        }
      }
    };
    
    // å‹•ç”»ç·¨é›†ç”¨ã®å ´åˆã€æœ€é«˜å“è³ªã‚’å¼·åˆ¶å–å¾—
    if (options.purpose === 'editing') {
      console.log('ğŸ¬ å‹•ç”»ç·¨é›†ç”¨: æœ€é«˜ç”»è³ªè¨­å®šã‚’é©ç”¨');
      
      // æœ€é«˜å“è³ªã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ‰‹å‹•é¸æŠ
      const bestFormat = formats
        .filter(f => f.hasVideo && f.hasAudio)
        .sort((a, b) => {
          // è§£åƒåº¦ã‚’å„ªå…ˆã€æ¬¡ã«ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã‚’æ¯”è¼ƒ
          const heightDiff = (parseInt(b.height) || 0) - (parseInt(a.height) || 0);
          if (heightDiff !== 0) return heightDiff;
          return (parseInt(b.bitrate) || 0) - (parseInt(a.bitrate) || 0);
        })[0];
        
      if (bestFormat) {
        ytdlOptions.format = bestFormat.itag;
        console.log(`ğŸ† é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${bestFormat.height}p, ${bestFormat.container}, itag=${bestFormat.itag}`);
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¤‡æ•°ã®é«˜å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è©¦è¡Œ
        ytdlOptions.quality = [
          'best[height>=1080]',
          'best[height>=720]', 
          'highestvideo+bestaudio',
          'highest'
        ];
        console.log('âš ï¸ æ‰‹å‹•é¸æŠå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å“è³ªè¨­å®šã‚’ä½¿ç”¨');
      }
    } else {
      // å­—å¹•è§£æç”¨ã¯åŠ¹ç‡é‡è¦–
      ytdlOptions.quality = 'highest';
    }
    
    // ç”¨é€”ã‚’ãƒ­ã‚°å‡ºåŠ›
    if (options.purpose) {
      console.log(`ğŸ“¹ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨é€”: ${options.purpose === 'analysis' ? 'å­—å¹•è§£æç”¨' : 'å‹•ç”»ç·¨é›†ç”¨'}`);
    }
    
    // é–‹å§‹æ™‚é–“ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆçµ‚äº†æ™‚é–“ã®æŒ‡å®šã¯ä¸å¯ï¼‰
    if (options.startTime) {
      ytdlOptions.begin = options.startTime;
      console.log(`â±ï¸ é–‹å§‹æ™‚é–“ ${options.startTime} ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`);
    }
    
    // é«˜å“è³ªã®å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const stream = ytdl(url, ytdlOptions);
    
    const writeStream = fs.createWriteStream(outputPath);
    
    return new Promise((resolve, reject) => {
      stream.pipe(writeStream);
      
      stream.on('error', (error) => {
        console.error('ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼:', error);
        reject(error);
      });
      
      writeStream.on('finish', async () => {
        console.log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${outputPath}`);
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªã‚’ç¢ºèª
        try {
          const { exec } = await import('child_process');
          const { promisify } = await import('util');
          const execAsync = promisify(exec);
          
          const { stdout } = await execAsync(`ffprobe -v quiet -print_format json -show_streams "${outputPath}"`);
          const probe = JSON.parse(stdout);
          const videoStream = probe.streams.find(s => s.codec_type === 'video');
          
          if (videoStream) {
            console.log(`ğŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å“è³ªç¢ºèª:`);
            console.log(`   è§£åƒåº¦: ${videoStream.width}x${videoStream.height}`);
            console.log(`   ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: ${eval(videoStream.r_frame_rate || '0/1').toFixed(2)}fps`);
            console.log(`   ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯: ${videoStream.codec_name}`);
            
            const fileSizeInMB = (require('fs').statSync(outputPath).size / 1024 / 1024).toFixed(1);
            console.log(`   ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${fileSizeInMB}MB`);
          }
        } catch (error) {
          console.log('âš ï¸ å“è³ªç¢ºèªã«å¤±æ•—:', error.message);
        }
        
        resolve({
          videoId,
          title: info.videoDetails.title,
          duration: info.videoDetails.lengthSeconds,
          filename,
          path: outputPath,
          url: info.videoDetails.video_url,
          timeRange: options.startTime || options.endTime ? {
            start: options.startTime || '0:00',
            end: options.endTime || info.videoDetails.lengthSeconds
          } : null
        });
      });
      
      writeStream.on('error', (error) => {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        reject(error);
      });
    });
  } catch (error) {
    console.error('YouTubeãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error(`å‹•ç”»ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
  }
}